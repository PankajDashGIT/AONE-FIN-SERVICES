{% extends "inventory/base.html" %}
{% load static %}
{% block content %}


<h2 class="mb-4">Sales Dashboard</h2>

<!-- KPI CARDS -->
<div class="row g-3 mb-3">

    <!-- Today Sales -->
    <div class="col-12 col-sm-6 col-md-3">
        <div class="card shadow-sm border-0 kpi-card kpi-blue">
            <div class="card-body d-flex align-items-center">
                <div class="kpi-icon me-3">
                    <i class="bi bi-lightning-charge"></i>
                </div>
                <div>
                    <div class="kpi-label">Today's Sales</div>
                    <div class="kpi-value">₹ <span id="kpi_today_sales">0.00</span></div>
                    <div class="kpi-sub">All bills for today</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Last 7 Days -->
    <div class="col-12 col-sm-6 col-md-3">
        <div class="card shadow-sm border-0 kpi-card kpi-green">
            <div class="card-body d-flex align-items-center">
                <div class="kpi-icon me-3">
                    <i class="bi bi-calendar-week"></i>
                </div>
                <div>
                    <div class="kpi-label">Last 7 Days</div>
                    <div class="kpi-value">₹ <span id="kpi_last7_sales">0.00</span></div>
                    <div class="kpi-sub">Rolling 7-day revenue</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Sales (range) -->
    <div class="col-12 col-sm-6 col-md-3">
        <div class="card shadow-sm border-0 kpi-card kpi-dark">
            <div class="card-body d-flex align-items-center">
                <div class="kpi-icon me-3">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div>
                    <div class="kpi-label">Total Sales</div>
                    <div class="kpi-value">₹ <span id="kpi_total_sales">0.00</span></div>
                    <div class="kpi-sub">For selected range</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Qty Sold -->
    <div class="col-12 col-sm-6 col-md-3">
        <div class="card shadow-sm border-0 kpi-card kpi-yellow">
            <div class="card-body d-flex align-items-center">
                <div class="kpi-icon me-3">
                    <i class="bi bi-bag-check"></i>
                </div>
                <div>
                    <div class="kpi-label">Total Qty</div>
                    <div class="kpi-value"><span id="kpi_total_qty">0</span></div>
                    <div class="kpi-sub">Items sold in range</div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- SECOND ROW: payment, best article, quick actions -->
<div class="row g-3 mb-4">

    <!-- Payment summary -->
    <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header payment-header d-flex justify-content-between align-items-center">
                <strong>Payment Modes</strong>
                <i class="bi bi-wallet2 text-muted"></i>
            </div>
            <div class="card-body" id="payment_modes_container">
                <div class="text-muted small">No sales yet.</div>
            </div>
        </div>
    </div>

    <!-- Best selling article -->
    <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header article-header d-flex justify-content-between align-items-center">
                <strong>Best Selling Article</strong>
                <i class="bi bi-star-fill text-warning"></i>
            </div>
            <div class="card-body" id="best_article_container">
                <div class="text-muted small">No sales yet.</div>
            </div>
        </div>
    </div>

    <!-- Quick actions -->
    <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <strong>Quick Actions</strong>
                <i class="bi bi-lightning-fill text-primary"></i>
            </div>
            <div class="card-body d-grid gap-2">
                <a href="/billing/" class="btn btn-dark d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-cash-stack me-2"></i>Billing / POS</span>
                    <i class="bi bi-arrow-right-short"></i>
                </a>
                <a href="/ledger/" class="btn btn-outline-secondary d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-box-seam me-2"></i>Stock Ledger</span>
                    <i class="bi bi-arrow-right-short"></i>
                </a>
                <button id="btn_export_excel"
                        class="btn btn-success d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-file-earmark-excel me-2"></i>Export Sales (Excel)</span>
                    <i class="bi bi-download"></i>
                </button>
            </div>
        </div>
    </div>

</div>

<!-- CHARTS ROW -->
<div class="row g-3 mb-4">

    <!-- Sales trend (built from table data) -->
    <div class="col-12 col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-header trend-header d-flex justify-content-between align-items-center">
                <strong>Sales Trend</strong>
                <small class="text-muted">Amount per day</small>
            </div>
            <div class="card-body">
                <canvas id="chart_sales_trend" height="120"></canvas>
            </div>
        </div>
    </div>

    <!-- Payment mode pie -->
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <strong>Payment Mode Split</strong>
                <small class="text-muted">₹ share by mode</small>
            </div>
            <div class="card-body">
                <canvas id="chart_payment_modes" height="200"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- FILTERS (COLLAPSIBLE) -->
<div class="card shadow-sm mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Filters & Search</strong>
        <button class="btn btn-sm btn-outline-secondary d-md-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#filter_collapse"
                aria-expanded="false"
                aria-controls="filter_collapse">
            <i class="bi bi-funnel me-1"></i> Filters
        </button>
    </div>

    <div id="filter_collapse" class="collapse show">
        <div class="card-body">

            <div class="row g-3 align-items-end">
                <div class="col-12 col-sm-6 col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="text" id="filter_start" class="form-control" placeholder="dd-mm-yyyy">
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="text" id="filter_end" class="form-control" placeholder="dd-mm-yyyy">
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <button id="btn_apply_filter" class="btn btn-primary w-100">
                        <i class="bi bi-check2-circle me-1"></i>Apply Filter
                    </button>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <button id="btn_clear_filter" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-x-circle me-1"></i>Clear Filter
                    </button>
                </div>
            </div>

            <div class="row mt-3 align-items-center">
                <div class="col-12 col-md-6 mb-2 mb-md-0">
                    <input type="text" id="search_box"
                           class="form-control"
                           placeholder="Search (Bill, article, category, size...)">
                </div>
                <div class="col-12 col-md-6 text-md-end small text-muted" id="table_meta_text">
                    Showing sales table with pagination
                </div>
            </div>

        </div>
    </div>
</div>

<!-- TABLE -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <strong>Sales Details</strong>
        <small id="summary_badge" class="badge bg-light text-dark d-none"></small>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive mb-0">
            <table class="table table-striped table-sm mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Bill No</th>
                        <th>Date</th>
                        <th>Article</th>
                        <th>Category</th>
                        <th>Size</th>
                        <th class="text-end">Qty</th>
                        <th class="text-end">Amount (₹)</th>
                        <th>Payment</th>
                    </tr>
                </thead>
                <tbody id="sales_table_body">
                    <tr>
                        <td colspan="8" class="text-center text-muted py-3">
                            Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card-footer d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
        <div class="d-flex align-items-center">
            <label class="me-2 mb-0 small text-muted">Rows per page</label>
            <select id="rows_per_page" class="form-select form-select-sm" style="width:auto;">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>

        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="btn_prev_page">
                <i class="bi bi-chevron-left"></i>
            </button>
            <span class="small">
                Page <span id="current_page">1</span> / <span id="total_pages">1</span>
            </span>
            <button class="btn btn-sm btn-outline-secondary" id="btn_next_page">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{# Bootstrap Icons (if not already loaded in base.html) #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

{# Chart.js CDN #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script src="{% static 'inventory/js/sales_dashboard.js' %}?v=2"></script>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'inventory/css/sales_dashboard.css' %}?v=1">
{% endblock %}