{% extends 'inventory/base.html' %}
{% load static %}

{% block content %}
<h3>Stock Ledger / Inventory Summary</h3>

<!-- FILTERS -->
<form id="ledger_filters" method="get" class="row mb-3">
    <div class="col-md-3">
        <label>Brand</label>
        <select id="led_brand" name="brand" class="form-select">
            <option value="">Brand</option>
            {% for b in brands %}
                <option value="{{ b.id }}" {% if request.GET.brand == b.id|stringformat:"s" %}selected{% endif %}>
                    {{ b.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-3">
        <label>Category</label>
        <select id="led_category" name="category" class="form-select">
            <option value="">Category</option>
            {% for c in categories %}
                <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label>Section</label>
        <select id="led_section" name="section" class="form-select">
            <option value="">Section</option>
            {% for s in sections %}
                <option value="{{ s.id }}" {% if request.GET.section == s.id|stringformat:"s" %}selected{% endif %}>
                    {{ s.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label>Size</label>
        <select id="led_size" name="size" class="form-select">
            <option value="">Size</option>
            {% for sz in sizes %}
                <option value="{{ sz.id }}" {% if request.GET.size == sz.id|stringformat:"s" %}selected{% endif %}>
                    {{ sz.value }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label>Supplier</label>
        <select id="led_supplier" name="supplier" class="form-select">
            <option value="">Supplier</option>
            {% for sup in suppliers %}
                <option value="{{ sup.id }}" {% if request.GET.supplier == sup.id|stringformat:"s" %}selected{% endif %}>
                    {{ sup.name }}
                </option>
            {% endfor %}
        </select>
    </div>
</form>

<div class="d-flex justify-content-between mb-2">
    <div>
        <button id="expandAll" class="btn btn-sm btn-outline-primary">Expand All</button>
        <button id="collapseAll" class="btn btn-sm btn-outline-secondary">Collapse All</button>
    </div>

    <a href="{% url 'export_stock_ledger_excel' %}?{{ request.GET.urlencode }}"
       class="btn btn-success btn-sm">
        ⬇ Export to Excel
    </a>
</div>

<!-- LEDGER TABLE -->
<div class="card p-3">
<table class="table table-sm table-bordered align-middle">

<thead class="table-dark">
<tr>
    <th></th>
    <th>Brand</th>
    <th>Category</th>
    <th>Section</th>
    <th>Size</th>
    <th class="text-end">Stock</th>
    <th class="text-end">MRP</th>
    <th class="text-end">Valuation</th>
    <th class="text-end">Billing</th>
    <th>Supplier</th>
    <th>Bill No</th>
</tr>
</thead>

<tbody>

{% regroup stocks by product.brand.name as brand_groups %}
{% for brand in brand_groups %}
<tr class="table-dark">
    <td colspan="11"><strong>Brand: {{ brand.grouper }}</strong></td>
</tr>

{% regroup brand.list by product.category.name as category_groups %}
{% for cat in category_groups %}
<tr class="table-secondary">
    <td colspan="11"><strong>Category: {{ cat.grouper }}</strong></td>
</tr>

{% for s in cat.list %}
<tr {% if s.quantity <= 5 %}class="table-danger"{% endif %}>
    <td class="text-center">
        <button class="btn btn-sm btn-outline-primary toggle-details"
                data-stock-id="{{ s.id }}">+</button>
    </td>

    <td>{{ s.product.brand.name }}</td>
    <td>{{ s.product.category.name }}</td>
    <td>{{ s.product.section.name }}</td>
    <td>{{ s.product.size.value }}</td>

    <td class="text-end">{{ s.quantity }}</td>
    <td class="text-end">₹ {{ s.product.mrp|floatformat:2 }}</td>
    <td class="text-end">₹ {{ s.valuation|floatformat:2 }}</td>

    <td class="text-end">
        {% if s.billing_price %}₹ {{ s.billing_price|floatformat:2 }}{% else %}-{% endif %}
    </td>

    <td>{{ s.supplier_name|default:"-" }}</td>
    <td>{{ s.bill_number|default:"-" }}</td>
</tr>

<tr id="details-{{ s.id }}" class="bg-light" style="display:none;">
    <td colspan="11">
        <div id="details-content-{{ s.id }}" class="p-2">
            Loading details...
        </div>
    </td>
</tr>
{% endfor %}
{% endfor %}
{% endfor %}

</tbody>

<tfoot>
<tr class="table-secondary">
    <th colspan="5" class="text-end">Totals</th>
    <th class="text-end">{{ totals.total_qty }}</th>
    <th></th>
    <th class="text-end">₹ {{ totals.total_valuation|floatformat:2 }}</th>
    <th colspan="3"></th>
</tr>
</tfoot>

</table>

{% if page_obj.has_other_pages %}
<nav class="mt-3">
<ul class="pagination justify-content-end">
    {% if page_obj.has_previous %}
    <li class="page-item">
        <a class="page-link"
           href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">
            Previous
        </a>
    </li>
    {% endif %}

    <li class="page-item disabled">
        <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
        <a class="page-link"
           href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">
            Next
        </a>
    </li>
    {% endif %}
</ul>
</nav>
{% endif %}

<small class="text-muted">Low stock (≤5) highlighted in red.</small>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'inventory/js/ledger.js' %}"></script>
{% endblock %}
